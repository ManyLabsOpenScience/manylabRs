---
title: "ManyLabs2 Data Cleaning"
author: "[ManyLabs2](https://osf.io/8cd4r) (Corresponding coder: [Fred Hasselman](https://osf.io/ujgs6/))"
date: "24 October 2015"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r,echo=FALSE}
require(manylabRs)
library(reshape2)
library(plyr)
library(broom)
```

# Analysis Strategy

The ManyLabs2 data analysis strategy attempts to regard three principles that maximize research transparency:
  
 1. **Principle of Equality**: All data should be treated equally by a code. That is, the code should do its job generating results while at the same time being as naive as possible to the particular facts of the study being analysed. This will reduce any chances of bias with respect to the outcomes of a certain dataset or a particular study. If it is necessary to add study specific code, the second principle should be regarded.
 
 2. **Principle of Transparency**: All operations that are crucial for obtaining an analysis result should be available for inspection by anyone who wishes to do so. This should be possible without the help of the auhtors that generated the code. The operations concern the application of data filtering rules, computation of variables derived from original measurements, running an analysis and constructing graphs, tables and figures. If full transparency is not possible, the third principle should be regarded. 
 
 3. **Principle of Reproducibility**: The most basic requirement for analysis results is that they should be reproducable given the original code and the original data set. However, any new implementation of the same analysis strategy in a different context, or application of the code to a different dataset, e.g. a replication study, should not be problematic. That is, outcomes may differ between data sets, but this should not be attributable to any details of the code or the analysis strategy.  
    
    
## `R` as a parser of online code.    

The [pre-registered Manylabs2 protocol](https://docs.google.com/document/d/1B5sVz3jlKMGnpxik-cfCeR8ngeQ249bzQExaVd5FzZM/edit) describes a number of analyses per replication study that can be categorised as **Primary** (target replications per site), **Secondary** (additional analyses per site, e.g. on subgroups), and **Global** (analyses on the entire dataset). 

These *promised analyses* have all been implemented in `R` in a transparent way and this implementation is now ready for an independent review.    

## Implementation

Functions avalaible in an [`R` package on GitHub](https://github.com/ManyLabsOpenScience/manylabRs) ([PDF manual](https://github.com/ManyLabsOpenScience/manylabRs/blob/master/inst/manylabRs.pdf)) extract information and instructions about each promised analysis a table that is openly accessible, the [masteRkey spreadsheet](https://docs.google.com/spreadsheets/d/1fqK3WHwFPMIjNVVvmxpMEjzUETftq_DmP5LzEhXxUHA/edit#gid=769239110).

Each row in the table represents an analysis, the columns contain specific information about the analysis:   

* Columns A through E are identifiers for study, analysis and slate.

* Column F and G contain `R` commands which will extract and label the columnms from the dataset needed for the analysis.

* Column H and I contain filter instructions for cases and subsamnples.

* Columns J through L contain information about the nature of the analysis (Global, Primary Secondary).

* Columns M through O contain information for study inclusion in figures and tables

* Column P lists the name of a analysis specific *variable function* (`varfun.`) which in most cases just reorganises the variables specified in previous columns so they can be passed to the analysis code. In some cases these function perform specific calculations required by the original analyses.

* Columns Q through V contain information about the statistiscal tests 

The `R` package [**manylabRs**](https://github.com/ManyLabsOpenScience/manylabRs) contains the `R` functions that can read the information from this sheet and conduct analyses on the data.


## Install the package

Several ways to install the package.

### Source from GitHub

Use the code below to install the `manylabRs` package directly from [GitHub](https://github.com/ManyLabsOpenScience/manylabRs).

```{r, eval=FALSE}
library(devtools)
install_github("ManyLabsOpenScience/manylabRs")
```

### Download tarball from GitHub

First [download the tarball](https://github.com/ManyLabsOpenScience/manylabRs/pkg/), then install the package locally through the RStudio package installer: `Tools` >> `Install Packages...`


## Main function

The main function to inspect is `get.analyses()`.  

It will take one or more take analysis (`studies`) from the `masteRkey` sheet and an indication of whether the analysis is:
1. `global` - will disregard the clusters in the data and use all valid caes for analyses, both `primary` and `secondary` analyses have a `global` variant.
2. `primary`- target analysis of replication study conducted for each lab seperately.
3. `secondary` - additional analyses for each lab conducted for each lab seperately.
4. `order` - presentation order analyses disregard the clusters int he data, each order is analysed seperately

> Have a look at [`saveConsole.R`](https://github.com/ManyLabsOpenScience/manylabRs/blob/master/inst/saveConsole.R) which calls the `testScript()` function and creates a log file with lots of info about the analysis steps.


The example below runs a global analysis for `Huang.1`
```{r}
library(manylabRs)
library(tidyverse)

df <- get.analyses(studies = 1, analysis.type = 1)
```

The object `df` contains two named lists:^[the names correspond to the analysis name in the `masteRkey`]

### `raw.case`

This list contains dataframes with the relevant variables for each analysis, but before the analysis specific variable functions (`vafun`) are applied. There is a Boolean variable `case.include` which indicates whther a case is valid and should be included for analysis.

```{r}
head(tbl_df(df$raw.case$Huang.1))
```

### `aggregated`    

The dataframe in `aggregated` contains the data as is was analysed, after the `varfun` is applied.

```{r}
glimpse(tbl_df(df$aggregated$Huang.1))
```


The output contains descriptives and sample summary characteristics and a variety of Effect Size measures.
It also contains the console output of the statistical test that was conducted:

```{r}
cat(paste0(df$aggregated$Huang.1$test.ConsoleOutput))
```

## Other algorithms

+ Get information from `masteRkey` on the analyses to run: `get.info()`
+ Get a data filter based on exclusion criteria: `get.chain()`
+ Select the appropriate variables: `get.sourceData()`
+ Apply the analysis-specific variable function: `varfun.ABC.#()`
+ Apply the analysis listed in column `stat.test` to the data
+ Organise the output `get.desriptives()`
+ Calculate confidence intervals for effect sizes `any2any()`
+ Return the ouput





